package com.maxwellwheeler.plugins.tppets.test.listeners;

import com.maxwellwheeler.plugins.tppets.TPPets;
import com.maxwellwheeler.plugins.tppets.helpers.GuestManager;
import com.maxwellwheeler.plugins.tppets.helpers.LogWrapper;
import com.maxwellwheeler.plugins.tppets.listeners.ListenerPetAccess;
import com.maxwellwheeler.plugins.tppets.storage.SQLWrapper;
import com.maxwellwheeler.plugins.tppets.test.MockFactory;
import org.bukkit.ChatColor;
import org.bukkit.block.Chest;
import org.bukkit.entity.AbstractHorse;
import org.bukkit.entity.Donkey;
import org.bukkit.entity.Player;
import org.bukkit.event.inventory.InventoryOpenEvent;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.LlamaInventory;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.sql.SQLException;
import java.util.Hashtable;

import static org.mockito.Mockito.*;

public class TPPListenerPetAccessInventoryOpenTest {
    private Player player;
    private Player guest;
    private LogWrapper logWrapper;
    private Inventory inventory;
    private TPPets tpPets;
    private ListenerPetAccess petInventoryProtector;
    private SQLWrapper sqlWrapper;

    @BeforeEach
    public void beforeEach() {
        this.player = MockFactory.getMockPlayer("MockPlayerId", "MockPlayerName", null, null, new String[]{});
        this.guest = MockFactory.getMockPlayer("MockGuestId", "MockGuestName", null, null, new String[]{});
        Donkey donkey = MockFactory.getTamedMockEntity("MockPetId", Donkey.class, this.player);
        this.inventory = mock(LlamaInventory.class);
        when(this.inventory.getHolder()).thenReturn(donkey);

        this.sqlWrapper = mock(SQLWrapper.class);
        this.logWrapper = mock(LogWrapper.class);
        this.tpPets = MockFactory.getMockPlugin(this.sqlWrapper, this.logWrapper, false, false);

        when(this.player.hasPermission("tppets.mountother")).thenReturn(false);

        this.petInventoryProtector = new ListenerPetAccess(this.tpPets);
    }

    InventoryOpenEvent getInventoryOpenEvent(Player sender) {
        InventoryOpenEvent inventoryOpenEvent = mock(InventoryOpenEvent.class);
        when(inventoryOpenEvent.getInventory()).thenReturn(this.inventory);
        when(inventoryOpenEvent.getPlayer()).thenReturn(sender);

        return inventoryOpenEvent;
    }

    @Test
    @DisplayName("Restricts inventory open events when player is not allowed to pet")
    void inventoryOpenEventRestrictedPlayerNotAllowedToPet() {
        InventoryOpenEvent inventoryOpenEvent = getInventoryOpenEvent(this.guest);

        this.petInventoryProtector.onInventoryOpen(inventoryOpenEvent);

        verify(this.guest, times(1)).sendMessage(ChatColor.RED + "You don't have permission to do that");
        verify(this.logWrapper, times(1)).logUnsuccessfulAction("Player with UUID MockGuestId was denied permission to access pet MockPetId");
        verify(inventoryOpenEvent, times(1)).setCancelled(true);
    }

    @Test
    @DisplayName("Doesn't restrict inventory open events when player has tppets.mountother")
    void inventoryOpenEventAllowedMountOtherPerms() {
        when(this.guest.hasPermission("tppets.mountother")).thenReturn(true);

        InventoryOpenEvent inventoryOpenEvent = getInventoryOpenEvent(this.guest);

        this.petInventoryProtector.onInventoryOpen(inventoryOpenEvent);

        verify(this.guest, never()).sendMessage(anyString());
        verify(this.logWrapper, never()).logUnsuccessfulAction(anyString());
        verify(inventoryOpenEvent, never()).setCancelled(anyBoolean());
    }

    @Test
    @DisplayName("Doesn't restrict inventory open events when player owns the pet")
    void inventoryOpenEventAllowedPlayerOwnsPerms() {
        InventoryOpenEvent inventoryOpenEvent = getInventoryOpenEvent(this.player);

        this.petInventoryProtector.onInventoryOpen(inventoryOpenEvent);

        verify(this.player, never()).sendMessage(anyString());
        verify(this.logWrapper, never()).logUnsuccessfulAction(anyString());
        verify(inventoryOpenEvent, never()).setCancelled(anyBoolean());
    }

    @Test
    @DisplayName("Doesn't restrict inventory open events when player is explicitly allowed to the pet")
    void inventoryOpenEventAllowedPlayerExplicitlyAllowed() throws SQLException {
        when(this.sqlWrapper.getAllAllowedPlayers()).thenReturn(new Hashtable<>());
        GuestManager guestManager = new GuestManager(this.sqlWrapper);
        guestManager.addGuest("MockHorseId", "MockGuestId");

        when(this.tpPets.getGuestManager()).thenReturn(guestManager);

        InventoryOpenEvent inventoryOpenEvent = getInventoryOpenEvent(this.player);

        this.petInventoryProtector.onInventoryOpen(inventoryOpenEvent);

        verify(this.guest, never()).sendMessage(anyString());
        verify(this.logWrapper, never()).logUnsuccessfulAction(anyString());
        verify(inventoryOpenEvent, never()).setCancelled(anyBoolean());
    }

    @Test
    @DisplayName("Doesn't restrict inventory open events when inventory clicked is not a pet")
    void inventoryOpenEventAllowedClickedChest() {
        Chest chest = mock(Chest.class);
        when(this.inventory.getHolder()).thenReturn(chest);

        InventoryOpenEvent inventoryOpenEvent = getInventoryOpenEvent(this.player);

        this.petInventoryProtector.onInventoryOpen(inventoryOpenEvent);

        verify(this.guest, never()).sendMessage(anyString());
        verify(this.logWrapper, never()).logUnsuccessfulAction(anyString());
        verify(inventoryOpenEvent, never()).setCancelled(anyBoolean());
    }

    @Test
    @DisplayName("Doesn't restrict inventory open events when inventory clicked is not a tracked pet type")
    void inventoryOpenEventAllowedUntrackedPetType() {
        AbstractHorse horse = mock(AbstractHorse.class);
        when(this.inventory.getHolder()).thenReturn(horse);

        InventoryOpenEvent inventoryOpenEvent = getInventoryOpenEvent(this.player);

        this.petInventoryProtector.onInventoryOpen(inventoryOpenEvent);

        verify(this.guest, never()).sendMessage(anyString());
        verify(this.logWrapper, never()).logUnsuccessfulAction(anyString());
        verify(inventoryOpenEvent, never()).setCancelled(anyBoolean());
    }


}
